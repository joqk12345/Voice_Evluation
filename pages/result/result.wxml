<!--pages/result/result.wxml - æ²‰æµ¸å¼èˆå°é£æ ¼ï¼Œå¢å¼ºç¤¾äº¤ä¼ æ’­åŠ›-->
<view class="result-container">
  <!-- èˆå°ç¯å…‰èƒŒæ™¯ -->
  <view class="stage-background">
    <view class="light-beam light-1"></view>
    <view class="light-beam light-2"></view>
    <view class="light-beam light-3"></view>
    <!-- éŸ³ä¹å…ƒç´ åŠ¨ç”» -->
    <view class="music-elements">
      <text class="music-note note-1">â™ª</text>
      <text class="music-note note-2">â™«</text>
      <text class="music-note note-3">â™¬</text>
      <text class="music-note note-4">â™ª</text>
    </view>
  </view>

  <!-- é¡¶éƒ¨æ ‡é¢˜åŒºï¼šä»Šæ—¥å£°éŸ³æŠ¥å‘Š -->
  <view class="title-section">
    <text class="main-title">ä»Šæ—¥å£°éŸ³æŠ¥å‘Š</text>
    <text class="title-emoji">ğŸ¶</text>
    <text class="sub-title">{{currentDate}}</text>
  </view>

  <!-- éäººå£°æç¤ºï¼ˆä»…å½“äººå£°æ£€æµ‹å¯ç”¨ä¸”æ£€æµ‹åˆ°éäººå£°æ—¶æ˜¾ç¤ºï¼‰ -->
  <view class="voice-warning" wx:if="{{!isVoice && voiceReason && voiceReason.indexOf('å·²ç¦ç”¨') === -1}}">
    <view class="warning-content">
      <text class="warning-icon">âš ï¸</text>
      <view class="warning-text">
        <text class="warning-title">æœªæ£€æµ‹åˆ°äººå£°</text>
        <text class="warning-desc">{{voiceReason || 'è¯·ç¡®ä¿å½•åˆ¶çš„æ˜¯æ‚¨çš„æ­Œå£°'}}</text>
      </view>
    </view>
  </view>

  <!-- æ—¶é•¿æç¤º -->
  <view class="voice-warning" wx:if="{{durationCheck && durationCheck.penalty > 0}}">
    <view class="warning-content">
      <text class="warning-icon">ğŸ“</text>
      <view class="warning-text">
        <text class="warning-title">å½•éŸ³æ—¶é•¿ä¸åˆé€‚</text>
        <text class="warning-desc">{{durationCheck.reason}}</text>
      </view>
    </view>
  </view>

  <!-- æ—‹å¾‹æç¤ºï¼ˆä»…å½“æ—‹å¾‹æ£€æµ‹å¯ç”¨ä¸”æ£€æµ‹åˆ°æ— æ—‹å¾‹æ—¶æ˜¾ç¤ºï¼‰ -->
  <view class="voice-warning" wx:if="{{melodyCheck && !melodyCheck.hasMelody && melodyCheck.reason && melodyCheck.reason.indexOf('å·²ç¦ç”¨') === -1}}">
    <view class="warning-content">
      <text class="warning-icon">ğŸµ</text>
      <view class="warning-text">
        <text class="warning-title">æ—‹å¾‹ä¸æ˜æ˜¾</text>
        <text class="warning-desc">{{melodyCheck.reason}}</text>
      </view>
    </view>
  </view>

  <!-- æ³¢å½¢å’ŒéŸ³é«˜å±•ç¤ºï¼ˆä¸“ä¸šå¯è§†åŒ–ï¼‰ -->
  <view class="waveform-section" wx:if="{{hasWaveform}}">
    <view class="section-header">
      <text class="section-title">æ³¢å½¢ä¸éŸ³é«˜åˆ†æ</text>
      <text class="section-subtitle">Waveform & Pitch Analysis</text>
    </view>
    <view class="waveform-wrapper">
      <canvas 
        canvas-id="resultWaveformCanvas" 
        id="resultWaveformCanvas"
        class="waveform-canvas"
        style="width: 100%; height: 500rpx;"
      ></canvas>
    </view>
    </view>
    
  <!-- ä¸»åˆ†æ•°åŒºï¼šå¤§åœ†ç¯åˆ†æ•°ï¼ˆåŠ¨ç”»å…‰æ•ˆï¼‰ -->
  <view class="score-ring-section">
    <view class="score-ring-wrapper">
      <!-- å¤–åœˆå…‰æ™• -->
      <view class="ring-glow"></view>
      <!-- åˆ†æ•°åœ†ç¯ -->
      <view class="score-ring-container">
        <canvas 
          canvas-id="scoreRingCanvas" 
          id="scoreRingCanvas"
          class="score-ring-canvas"
        ></canvas>
        <view class="score-ring-content">
          <view id="scoreGroup" class="score-group">
            <text id="scoreText" class="ring-score-number">{{animatedScore}}</text>
            <text class="ring-score-unit">åˆ†</text>
          </view>
          <text class="ring-level-badge">{{scoreLevel.level}}</text>
        </view>
      </view>
    </view>
    
    <!-- ä¸ªæ€§åŒ–æ–‡æ¡ˆ -->
    <view class="personalized-message">
      <text class="message-text">{{personalizedMessage}}</text>
    </view>
    
    <!-- æ•°æ®å¯¹æ¯” -->
    <view class="comparison-stats" wx:if="{{comparisonPercent > 0}}">
      <text class="stats-text">è¶…è¿‡ {{comparisonPercent}}% çš„ç”¨æˆ·</text>
    </view>
  </view>

  <!-- å››é¡¹è¯„åˆ†åŒºï¼šå£°æ³¢å½¢è¿›åº¦æ¡ -->
  <view class="metrics-section">
    <view class="section-title">è¯¦ç»†åˆ†æ</view>
    <view class="metrics-grid">
      <view class="metric-card {{item.isHighScore ? 'metric-card-high' : 'metric-card-low'}}" wx:for="{{metricsList}}" wx:key="index">
        <view class="metric-header">
          <text class="metric-icon">{{item.icon}}</text>
          <text class="metric-name">{{item.name}}</text>
          <view class="metric-score-inline">
            <text class="score-value {{item.isHighScore ? 'score-value-high' : 'score-value-low'}}">{{item.score}}</text>
            <text class="score-unit">åˆ†</text>
          </view>
        </view>
        <!-- å£°æ³¢å½¢è¿›åº¦æ¡ -->
        <view class="waveform-progress-container">
          <view class="waveform-progress-bar" data-score="{{item.score}}" data-index="{{index}}">
            <view class="waveform-fill {{item.isHighScore ? 'waveform-fill-high' : 'waveform-fill-low'}}" style="width: {{item.score}}%;">
              <canvas 
                canvas-id="waveformBar{{index}}" 
                class="waveform-bar-canvas"
              ></canvas>
            </view>
          </view>
        </view>
        <view class="metric-advice {{item.isHighScore ? 'metric-advice-high' : 'metric-advice-low'}}">
          <text class="advice-text">{{item.advice}}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- æˆå°±å¾½ç« åŒº -->
  <view class="achievements-section" wx:if="{{achievements.length > 0}}">
    <view class="section-title">æˆå°±å¾½ç« </view>
    <view class="achievements-grid">
      <view class="achievement-badge" wx:for="{{achievements}}" wx:key="index">
        <view class="badge-icon">{{item.icon}}</view>
        <text class="badge-name">{{item.name}}</text>
      </view>
    </view>
  </view>

  <!-- æ”¹è¿›å»ºè®® -->
  <view class="advice-section">
    <view class="section-title">æ”¹è¿›å»ºè®®</view>
    <view class="advice-list">
      <view class="advice-item" wx:for="{{adviceList}}" wx:key="index">
        <text class="advice-icon">ğŸ’¡</text>
        <text class="advice-text">{{item}}</text>
      </view>
    </view>
  </view>

  <!-- ç»ƒä¹ ä¸€ä¸‹æŒ‰é’®ï¼ˆçªå‡ºæ˜¾ç¤ºï¼‰ -->
  <view class="recommend-section">
    <button class="recommend-btn-primary" bindtap="viewRecommend">
      <text class="btn-icon">ğŸ’ª</text>
      <text class="btn-text">ç»ƒä¹ ä¸€ä¸‹</text>
      <text class="btn-arrow">â†’</text>
    </button>
  </view>

  <!-- åˆ†äº«å¼•å¯¼åŒºï¼šäºŒç»´ç  + ä¸€é”®åˆ†äº«æŒ‰é’®ï¼ˆä¼˜åŒ–å¸ƒå±€ï¼Œæ›´ç´§å‡‘ï¼‰ -->
  <view class="share-section">
    <view class="share-content-compact">
      <view class="share-qrcode-wrapper">
        <image class="share-qrcode" src="/images/qrcode.png" mode="aspectFit"></image>
        <text class="qrcode-tip">æ‰«ç ä½“éªŒ</text>
      </view>
      
      <view class="share-buttons-compact">
        <button 
          class="share-btn-primary" 
          bindtap="generateShareImage"
        >
          <text class="btn-icon">âœ¨</text>
          <text class="btn-text">ç”Ÿæˆåˆ†äº«æµ·æŠ¥</text>
        </button>
        
        <button 
          class="share-btn-secondary" 
          bindtap="playRecord" 
          wx:if="{{recordFilePath}}"
        >
          <text class="btn-icon">{{isPlaying ? 'â¸ï¸' : 'â–¶ï¸'}}</text>
          <text class="btn-text">{{isPlaying ? 'æš‚åœ' : 'æ’­æ”¾'}}</text>
        </button>
      </view>
    </view>
  </view>

  <!-- éšè—çš„Canvasç”¨äºç”Ÿæˆå›¾ç‰‡ -->
  <canvas 
    canvas-id="shareCanvas" 
    id="shareCanvas"
    class="share-canvas"
  ></canvas>
</view>
