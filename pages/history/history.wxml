<!--pages/history/history.wxml - ç®€æ´æ¸©æš–é£æ ¼ï¼Œä¸é¦–é¡µç»Ÿä¸€-->
<view class="history-container">
  <!-- æƒ…ç»ªåŒ–æ ‡é¢˜ -->
  <view class="page-header">
    <text class="page-title">è¯„æµ‹å†å²</text>
    <text class="page-subtitle" wx:if="{{historyList.length > 0}}">å…±{{historyList.length}}æ¡è®°å½•</text>
    <text class="page-subtitle" wx:else>è®°å½•ä½ çš„æ¯ä¸€æ¬¡è¿›æ­¥ âœ¨</text>
  </view>

  <!-- ç»Ÿè®¡å¡ç‰‡ -->
  <view class="stats-card" wx:if="{{historyList.length > 0}}">
    <view class="stat-item">
      <text class="stat-number">{{totalTests}}</text>
      <text class="stat-label">æ€»æ¬¡æ•°</text>
    </view>
    <view class="stat-divider"></view>
    <view class="stat-item">
      <text class="stat-number">{{improvement > 0 ? '+' : ''}}{{improvement}}</text>
      <text class="stat-label">è¿›æ­¥</text>
    </view>
    <view class="stat-divider"></view>
    <view class="stat-item">
      <text class="stat-number">{{bestScore}}</text>
      <text class="stat-label">æœ€é«˜åˆ†</text>
    </view>
  </view>

  <!-- å˜åŒ–è¶‹åŠ¿æç¤º -->
  <view class="trend-tip" wx:if="{{recentChanges && recentChanges.length > 0}}">
    <text class="trend-tip-text">ğŸ“ˆ æœ€è¿‘å˜åŒ–ï¼š</text>
    <text class="trend-tip-value" wx:for="{{recentChanges}}" wx:key="date" wx:for-item="change">
      {{change.scoreChange > 0 ? '+' : ''}}{{change.scoreChange}}åˆ†
    </text>
  </view>

  <!-- å†å²è®°å½•åˆ—è¡¨ -->
  <view class="history-section">
    <view class="history-list" wx:if="{{historyList.length > 0}}">
      <view class="history-item" wx:for="{{historyList}}" wx:key="id" bindtap="viewDetail" data-item="{{item}}">
        <view class="item-main">
          <view class="item-left">
            <view class="score-circle">
              <text class="score-number">{{item.score}}</text>
            </view>
          </view>
          <view class="item-content">
            <view class="item-header">
              <text class="song-name">{{item.song || 'è‡ªå®šä¹‰è¯„æµ‹'}}</text>
              <text class="record-date">{{item.date}}</text>
            </view>
            <view class="item-metrics">
              <view class="metric-tag">
                <text class="metric-label">éŸ³å‡†</text>
                <text class="metric-value">{{item.pitch}}</text>
              </view>
              <view class="metric-tag">
                <text class="metric-label">èŠ‚å¥</text>
                <text class="metric-value">{{item.rhythm}}</text>
              </view>
              <view class="metric-tag">
                <text class="metric-label">éŸ³é‡</text>
                <text class="metric-value">{{item.volume}}</text>
              </view>
              <view class="metric-tag">
                <text class="metric-label">éŸ³è‰²</text>
                <text class="metric-value">{{item.timbre}}</text>
              </view>
            </view>
          </view>
        </view>
        <view class="item-actions">
          <!-- æ’­æ”¾æŒ‰é’® -->
          <view class="action-btn play-btn {{playingId === item.id ? 'playing' : ''}}" 
                catchtap="playRecord" 
                data-item="{{item}}"
                wx:if="{{item.recordFilePath}}">
            <text class="action-icon">{{playingId === item.id ? 'â¸ï¸' : 'â–¶ï¸'}}</text>
          </view>
          <!-- å¯¹æ¯”é€‰æ‹©æŒ‰é’® -->
          <view class="action-btn compare-btn {{item.selected ? 'selected' : ''}}" 
                catchtap="selectForComparison" 
                data-item="{{item}}">
            <text class="action-icon">ğŸ“Š</text>
          </view>
          <!-- åˆ é™¤æŒ‰é’® -->
          <view class="action-btn delete-btn" catchtap="deleteRecord" data-id="{{item.id}}">
            <text class="action-icon">ğŸ—‘ï¸</text>
          </view>
        </view>
      </view>
    </view>

    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-state" wx:else>
      <text class="empty-icon">ğŸ“Š</text>
      <text class="empty-title">è¿˜æ²¡æœ‰è¯„æµ‹è®°å½•</text>
      <text class="empty-desc">å¼€å§‹ä½ çš„ç¬¬ä¸€æ¬¡è¯„æµ‹å§</text>
      <button class="empty-action" bindtap="goToRecord">å¼€å§‹è¯„æµ‹</button>
    </view>
  </view>

  <!-- å¯¹æ¯”å¼¹çª— -->
  <view class="comparison-modal {{showComparison ? 'show' : ''}}" wx:if="{{showComparison && comparisonData}}" catchtap="closeComparison">
    <view class="comparison-content" catchtap="">
      <view class="comparison-header">
        <text class="comparison-title">ğŸ“Š å¯¹æ¯”åˆ†æ</text>
        <text class="comparison-close" bindtap="closeComparison">âœ•</text>
      </view>
      
      <view class="comparison-items">
        <view class="comparison-item">
          <text class="comparison-date">{{comparisonData.item1.date}}</text>
          <text class="comparison-score">{{comparisonData.item1.score}}åˆ†</text>
        </view>
        <view class="comparison-vs">VS</view>
        <view class="comparison-item">
          <text class="comparison-date">{{comparisonData.item2.date}}</text>
          <text class="comparison-score">{{comparisonData.item2.score}}åˆ†</text>
        </view>
      </view>

      <view class="comparison-diffs">
        <view class="diff-item">
          <text class="diff-label">æ€»åˆ†å˜åŒ–</text>
          <text class="diff-value {{comparisonData.scoreDiff > 0 ? 'positive' : 'negative'}}">
            {{comparisonData.scoreDiff > 0 ? '+' : ''}}{{comparisonData.scoreDiff}}åˆ†
          </text>
        </view>
        <view class="diff-item">
          <text class="diff-label">éŸ³å‡†</text>
          <text class="diff-value {{comparisonData.pitchDiff > 0 ? 'positive' : 'negative'}}">
            {{comparisonData.pitchDiff > 0 ? '+' : ''}}{{comparisonData.pitchDiff}}
          </text>
        </view>
        <view class="diff-item">
          <text class="diff-label">èŠ‚å¥</text>
          <text class="diff-value {{comparisonData.rhythmDiff > 0 ? 'positive' : 'negative'}}">
            {{comparisonData.rhythmDiff > 0 ? '+' : ''}}{{comparisonData.rhythmDiff}}
          </text>
        </view>
        <view class="diff-item">
          <text class="diff-label">éŸ³é‡</text>
          <text class="diff-value {{comparisonData.volumeDiff > 0 ? 'positive' : 'negative'}}">
            {{comparisonData.volumeDiff > 0 ? '+' : ''}}{{comparisonData.volumeDiff}}
          </text>
        </view>
        <view class="diff-item">
          <text class="diff-label">éŸ³è‰²</text>
          <text class="diff-value {{comparisonData.timbreDiff > 0 ? 'positive' : 'negative'}}">
            {{comparisonData.timbreDiff > 0 ? '+' : ''}}{{comparisonData.timbreDiff}}
          </text>
        </view>
      </view>

      <view class="comparison-insights" wx:if="{{comparisonData.improvements.length > 0 || comparisonData.regressions.length > 0}}">
        <view class="insight-section" wx:if="{{comparisonData.improvements.length > 0}}">
          <text class="insight-title">âœ… æ”¹è¿›ç‚¹ï¼š</text>
          <text class="insight-item" wx:for="{{comparisonData.improvements}}" wx:key="*this">{{item}}</text>
        </view>
        <view class="insight-section" wx:if="{{comparisonData.regressions.length > 0}}">
          <text class="insight-title">âš ï¸ éœ€æ³¨æ„ï¼š</text>
          <text class="insight-item" wx:for="{{comparisonData.regressions}}" wx:key="*this">{{item}}</text>
        </view>
        <view class="insight-section" wx:if="{{comparisonData.keyDifferences.length > 0}}">
          <text class="insight-title">ğŸ¯ å…³é”®å·®å¼‚ï¼š</text>
          <text class="insight-item" wx:for="{{comparisonData.keyDifferences}}" wx:key="*this">{{item}}</text>
        </view>
      </view>
    </view>
  </view>
</view>
