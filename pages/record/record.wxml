<!--pages/record/record.wxml - 简洁温暖风格，与首页统一-->
<view class="record-container">
  <!-- 情绪化提示 -->
  <view class="welcome-tip">
    <text class="tip-text">放松心情，唱出你的声音 🎵</text>
  </view>

  <!-- 录音核心区域 -->
  <view class="record-main">
    <!-- 大录音按钮 -->
    <view class="record-button-wrapper">
        <view class="record-button {{isRecording ? 'recording' : ''}}" bindtap="toggleRecord">
        <!-- 背景光晕效果 -->
        <view class="record-glow" wx:if="{{!isRecording}}"></view>
        <!-- 录音时的波动球效果（根据反馈优化） -->
        <view class="audio-ball-container" wx:if="{{isRecording}}">
          <view class="audio-ball" style="transform: scale({{audioBallScale}});">
            <view class="audio-ball-inner"></view>
            <view class="audio-ball-ripple ripple-1" style="animation-delay: 0s;"></view>
            <view class="audio-ball-ripple ripple-2" style="animation-delay: 0.3s;"></view>
            <view class="audio-ball-ripple ripple-3" style="animation-delay: 0.6s;"></view>
          </view>
        </view>
        <!-- 未录音时的图标 -->
        <view class="record-icon-wrapper" wx:if="{{!isRecording}}">
          <view class="record-icon">🎙️</view>
          <view class="icon-sparkles">
            <text class="sparkle sparkle-1">✨</text>
            <text class="sparkle sparkle-2">✨</text>
            <text class="sparkle sparkle-3">✨</text>
          </view>
        </view>
        <view class="record-status-text">{{isRecording ? '录音中...' : '点击开始'}}</view>
      </view>
    </view>

    <!-- 倒计时显示 -->
    <view class="countdown-display" wx:if="{{isRecording}}">
      <text class="countdown-number">{{countdown}}</text>
      <text class="countdown-label">秒</text>
    </view>

    <!-- 录音时间显示 -->
    <view class="time-display" wx:if="{{!isRecording && hasRecorded}}">
      <text class="time-text">{{formatTime(recordTime)}}</text>
      <text class="time-label">录音时长</text>
      </view>
      
    <!-- 简单设置 -->
    <view class="simple-settings" wx:if="{{!isRecording && !hasRecorded}}">
        <view class="setting-item">
        <text class="setting-label">录音时长</text>
          <picker 
            range="{{durationOptions}}" 
            range-key="label"
            value="{{selectedDurationIndex}}"
            bindchange="onDurationChange"
          >
          <view class="setting-picker">
            <text class="picker-text">{{durationOptions[selectedDurationIndex].label}}</text>
            <text class="picker-arrow">⌄</text>
            </view>
          </picker>
        </view>

      <!-- 高级设置按钮（Apple 风格） -->
      <view class="advanced-settings-btn" bindtap="toggleAdvancedSettings">
        <text class="advanced-btn-text">高级设置</text>
        <text class="advanced-btn-icon {{showAdvancedSettings ? 'expanded' : ''}}">⌄</text>
      </view>

      <!-- 高级功能按钮组（折叠） -->
      <view class="advanced-features {{showAdvancedSettings ? 'show' : ''}}" wx:if="{{showAdvancedSettings}}">
        <view class="feature-buttons">
          <view 
            class="feature-btn {{enableVoiceDetection ? 'active' : ''}}" 
            bindtap="toggleVoiceDetection"
          >
            <text class="feature-icon">🎤</text>
            <text class="feature-label">人声检测</text>
          </view>
          
          <view 
            class="feature-btn {{enableMelodyDetection ? 'active' : ''}}" 
            bindtap="toggleMelodyDetection"
          >
            <text class="feature-icon">🎵</text>
            <text class="feature-label">旋律检测</text>
          </view>
          
          <view 
            class="feature-btn {{enableWaveform ? 'active' : ''}}" 
            bindtap="toggleWaveform"
          >
            <text class="feature-icon">📊</text>
            <text class="feature-label">波形</text>
            </view>
        </view>
      </view>
    </view>

    <!-- 波形可视化区域（参考 tobiplayer 设计） -->
    <view class="waveform-container" wx:if="{{enableWaveform && (isRecording || hasRecorded)}}">
      <view class="waveform-header">
        <text class="waveform-title">波形与音高</text>
        <text class="waveform-pitch" wx:if="{{currentPitch > 0}}">{{currentPitchText}} Hz</text>
  </view>

      <canvas 
        id="waveformCanvas"
        type="2d"
        class="waveform-canvas"
        style="width: 100%; height: 500rpx;"
      ></canvas>
    </view>

    <!-- 录音完成提示 -->
    <view class="completion-hint" wx:if="{{recordCompleted}}">
      <text class="hint-icon">✅</text>
      <text class="hint-text">录音完成！可以开始分析了</text>
    </view>
  </view>

  <!-- 底部操作按钮 -->
  <view class="action-section">
    <button 
      class="action-btn primary" 
      bindtap="analyzeRecord"
      wx:if="{{recordCompleted}}"
      disabled="{{isAnalyzing}}"
    >
      {{isAnalyzing ? '分析中...' : '开始分析'}}
    </button>

    <button 
      class="action-btn primary" 
      bindtap="startRecord"
      wx:if="{{!hasRecorded && !isRecording}}"
    >
      开始录音
    </button>
    
    <button 
      class="action-btn secondary" 
      bindtap="stopRecord"
      wx:if="{{isRecording}}"
    >
      停止录音
    </button>
  </view>

  <!-- 加载遮罩 -->
  <view class="loading-overlay" wx:if="{{isAnalyzing}}">
    <view class="loading-content">
      <view class="loading-spinner"></view>
      <text class="loading-text">正在分析你的声音...</text>
      <text class="loading-desc">请稍候片刻</text>
    </view>
  </view>
</view>
