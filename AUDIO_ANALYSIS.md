# 音频分析技术文档

## 概述

本小程序使用基于 PCM 数据的专业音频分析技术，通过快速傅里叶变换（FFT）和音频特征提取，对声乐表演进行多维度评估。

## 技术架构

### 1. PCM 数据获取

- **录音格式**：使用微信录音接口的 `PCM` 格式获取原始音频数据
- **采样率**：16000 Hz（适合语音分析）
- **通道数**：单声道（1 channel）
- **帧大小**：每帧 0.1 秒（1600 个采样点）

```javascript
recorderManager.start({
  format: 'PCM',
  sampleRate: 16000,
  numberOfChannels: 1,
  frameSize: 1600 // 0.1 秒一帧
})
```

### 2. 实时数据收集

通过 `onFrameRecorded` 回调函数实时获取 PCM 数据帧：

```javascript
recorderManager.onFrameRecorded((res) => {
  // res.frameBuffer 是 ArrayBuffer 格式的 PCM 数据
  // 转换为 Float32Array 并归一化到 [-1, 1] 范围
})
```

## 音频特征分析

### 1. 快速傅里叶变换 (FFT)

**实现方式**：迭代版本的 Cooley-Tukey FFT 算法

**功能**：
- 将时域信号转换为频域信号
- 计算幅度谱和相位谱
- 提取频率信息

**性能优化**：
- 限制最大 FFT 大小为 2048 点
- 使用迭代实现，避免递归开销
- 位反转置换优化

### 2. RMS (Root Mean Square) - 均方根

**计算公式**：
```
RMS = sqrt(Σ(x²) / N)
```

**用途**：
- 评估音量水平
- 检测音量变化
- 评估音量一致性

**应用**：
- **音量评分**：音量适中（0.1-0.8）且稳定为佳
- **节奏检测**：识别节拍点（音量峰值）

### 3. ZCR (Zero Crossing Rate) - 过零率

**计算公式**：
```
ZCR = 过零次数 / (总采样数 - 1)
```

**用途**：
- 评估音色特征
- 区分不同声音类型
- 检测声音的清晰度

**人声特征**：
- 正常说话的 ZCR：0.05 - 0.15
- 清音（如"s"、"f"）的 ZCR 较高
- 浊音（如"a"、"o"）的 ZCR 较低

### 4. 能量谱 (Power Spectrum)

**计算公式**：
```
Power[i] = Magnitude[i]²
```

**用途**：
- 频率能量分布分析
- 基音频率检测
- 谐波分析

### 5. 基音频率检测 (Pitch Detection)

**方法**：
1. 在能量谱中找到最大能量峰值（80Hz - 1000Hz 范围内）
2. 检测谐波结构（2倍频、3倍频等）
3. 验证谐波存在以提高准确性

**应用**：
- **音准评估**：检测基音频率的稳定性和准确性
- **音高分析**：识别演唱的音高

## 评分算法

### 1. 音准评分 (Pitch Accuracy) - 30%

**评估维度**：
- **稳定性**（60%权重）：基音频率的标准差，越小越好
- **准确性**（40%权重）：与目标音高的偏差（如果有参考音高）

**计算公式**：
```javascript
stabilityScore = max(0, 100 - relativeStdDev * 200)
accuracyScore = max(0, 100 - pitchDeviation * 300)
finalScore = stabilityScore * 0.6 + accuracyScore * 0.4
```

### 2. 节奏评分 (Rhythm) - 25%

**评估维度**：
- 节拍点的规律性
- 节拍间隔的一致性

**方法**：
1. 检测音量峰值（节拍点）
2. 计算节拍间隔
3. 评估间隔的标准差

**计算公式**：
```javascript
rhythmScore = max(0, 100 - relativeStdDev * 150)
```

### 3. 音量评分 (Volume) - 25%

**评估维度**：
- **音量水平**（50%权重）：音量是否适中（0.1-0.8）
- **音量稳定性**（50%权重）：音量变化的一致性

**计算公式**：
```javascript
volumeLevelScore = f(meanRMS) // 根据平均 RMS 值评分
stabilityScore = max(0, 100 - relativeStdDev * 200)
finalScore = (volumeLevelScore + stabilityScore) / 2
```

### 4. 音色评分 (Timbre) - 20%

**评估维度**：
- **ZCR 分析**（60%权重）：人声的 ZCR 应该在 0.05-0.15 范围内
- **频谱分析**（40%权重）：检测谐波结构，评估音色丰富度

**计算公式**：
```javascript
zcrScore = f(meanZCR) // 根据平均 ZCR 值评分
harmonicScore = detectHarmonics(powerSpectrum) // 检测谐波数量
finalScore = zcrScore * 0.6 + harmonicScore * 0.4
```

### 5. 总分计算

**加权平均**：
```javascript
totalScore = pitch * 0.3 + rhythm * 0.25 + volume * 0.25 + timbre * 0.2
```

## 数据处理流程

```
录音开始
  ↓
实时收集 PCM 帧
  ↓
录音结束
  ↓
合并所有 PCM 帧
  ↓
分帧处理（每帧 0.1 秒）
  ↓
对每帧进行：
  - RMS 计算
  - ZCR 计算
  - FFT 变换
  - 能量谱计算
  - 基音频率检测
  ↓
汇总历史数据：
  - RMS 历史
  - ZCR 历史
  - 基音频率历史
  - 频谱历史
  ↓
评估各项指标：
  - 音准评分
  - 节奏评分
  - 音量评分
  - 音色评分
  ↓
计算总分
  ↓
返回分析结果
```

## 性能考虑

1. **FFT 大小限制**：最大 2048 点，平衡精度和性能
2. **分帧处理**：每帧 0.1 秒，减少计算量
3. **数据采样**：只保留前 100 个历史数据点
4. **异步处理**：使用 `setTimeout` 将计算放在下一个事件循环

## 注意事项

1. **PCM 格式限制**：
   - PCM 格式录音主要用于分析
   - 可能无法直接播放（需要转换为 wav/mp3）
   - 如果播放失败，会提示用户

2. **降级处理**：
   - 如果 PCM 数据获取失败，自动降级使用模拟分析
   - 确保用户体验不受影响

3. **精度限制**：
   - 16kHz 采样率适合语音分析
   - 更高采样率（如 44.1kHz）可提高精度但会增加计算量

## 未来改进方向

1. **更精确的音高检测**：使用自相关法或倒谱法
2. **节奏分析增强**：结合节拍检测算法
3. **音色模型**：建立更完善的音色评估模型
4. **实时反馈**：在录音过程中实时显示分析结果
5. **多语言支持**：针对不同语言的声乐特点优化算法







